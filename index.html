<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta name="description" content="Explore Marker-based AR - Scan markers, experience 3D models, and choose languages for an immersive AR adventure!">
        <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
        <link rel="stylesheet" href="style.css">
        <link rel="icon" href="assets/icons/log-out.png" type="image/png">
        <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/log-out.png">
    </head>

    <title>Marker-based Augmented Reality Experience</title>
    
    <body style="margin: 0; overflow: hidden;">
        <div class="container">
            <div id="info">
                <h1>Sample</h1>
            </div>
            </div>
            <div id="product-info-container">
                <div id="product-info"></div>
            </div>
            <button id="button" class="btn btn__primary"><span>Play</span></button>
            <button id="exit" class="exit btn__exit"><span>Exit</span></button>
            <select name="Language" id="lang" class="select btn__primary">
                <option value="en">English</option>
                <option value="zh">Chinese</option>
            </select>
        </div>
    
        <a-scene
            vr-mode-ui="enabled: false;"
            loading-screen="enabled: false;"
            renderer="logarithmicDepthBuffer: true;"
            arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
            embedded
        >
        </a-scene>
    
        <script>
            const info = document.querySelector("#info");
            const exit = document.querySelector("#exit");
            const product_Info = document.querySelector("#product-info");
            const langSelect = document.querySelector("#lang");
            const playBtn = document.querySelector("#button");
            
            info.style.display = "none";
            lang.style.display = "none";
            product_Info.style.display = "none";
            exit.style.display = "none";
            playBtn.style.display = "none";
            
            let selectedLanguage = "en"; // Default language is English.
            let markerDetected = false; // Flag to track if the marker is detected.
            
            function fetchContentFile(contentFiles, selectedLanguage) {
                const contentFile = contentFiles[selectedLanguage];
                return fetch(contentFile)
                    .then((response) => response.text())
                    .catch((error) => {
                        console.error("Error fetching content file:", error);
                        return "";
                    });
            }
            
            function updateProductInfo(content) {
                product_Info.innerHTML = content;
            }
            
            function fetchMarkerData() {
                return fetch("contents/content.json")
                    .then((response) => response.json())
                    .catch((error) => {
                        console.error("Error fetching marker data:", error);
                        return [];
                    });
            }

            function handleBeforeUnload() {
                stopPlay();
                localStorage.setItem("isPlaying", isPlaying);
            }
            
            window.addEventListener("beforeunload", handleBeforeUnload);
    
            const speech = window.speechSynthesis;
    
            function playInfo() {
                const productInfoText = product_Info.textContent;
                if (productInfoText) {
                    // const speech = window.speechSynthesis;
                    if (isPlaying) {
                        speech.cancel();
                        isPlaying = false;
                        playBtn.querySelector('span').textContent = 'Play';
                        playBtn.classList.remove('playing');
                    } else {
                        const utterance = new SpeechSynthesisUtterance(productInfoText);
                        speech.speak(utterance);
                        isPlaying = true;
                        playBtn.querySelector('span').textContent = 'Stop';
                        playBtn.classList.add('playing');
                    }
                }
            }
    
            function stopPlay() {
                const productInfoText = product_Info.textContent;
                if (productInfoText) {
                    // const speech = window.speechSynthesis;
                    if (isPlaying) {
                        speech.cancel();
                        isPlaying = false;
                        playBtn.querySelector('span').textContent = 'Play';
                        playBtn.classList.remove('playing');
                    }
                }
            }
    
            let isPlaying = false;
            playBtn.addEventListener("click", () => {
                playInfo();
            });
            
            fetchMarkerData().then((markers) => {
                const scene = document.querySelector("a-scene");

                let activeMarker = null;
        
                // Function to create a marker element for a given marker data
                function createMarkerElement(marker) {
                    const markerEl = document.createElement("a-marker");
                    markerEl.setAttribute("type", "pattern");
                    markerEl.setAttribute("url", marker.patternUrl);
        
                    const modelEl = document.createElement("a-entity");
                    modelEl.setAttribute("gltf-model", marker.modelUrl);
                    modelEl.setAttribute("position", "0 -2 -1");
                    modelEl.setAttribute("scale", "0.5 0.5 0.5");
                    modelEl.setAttribute("rotation", "-90 -90 90");
        
                    scene.appendChild(markerEl);
        
                    return markerEl;
                }
        
                function showContent(selectedLanguage, marker) {
                    fetchContentFile(marker.contentFiles, selectedLanguage).then((content) => {
                        updateProductInfo(content);
                    });
                }
        
                markers.forEach((marker) => {
                    const markerEl = createMarkerElement(marker);
                    markerEl.addEventListener("markerFound", () => {
                        if (!markerDetected) {
                            markerDetected = true;
                            activeMarker = marker; // Store the active marker
                            info.textContent = marker.info;
                            info.style.display = "block";
                            langSelect.style.display = "block";
                            exit.style.display = "block";
                            product_Info.style.display = "block";
                            playBtn.style.display = "block";
                            showContent(selectedLanguage, marker); // Load content based on selected language and current marker.
                        }
                    });
                });
        
                langSelect.addEventListener("change", () => {
                    selectedLanguage = langSelect.value;
                    if (activeMarker) {
                        showContent(selectedLanguage, activeMarker); // Load content based on selected language and current marker.
                        stopPlay();
                    }
                });
        
                exit.addEventListener("click", () => {
                    if (markerDetected) {
                        markerDetected = false;
                        activeMarker = null; // Clear the active marker
                        info.style.display = "none";
                        langSelect.style.display = "none";
                        product_Info.style.display = "none";
                        exit.style.display = "none";
                        playBtn.style.display = "none";
                        stopPlay();
                    }
                });
            });
        </script>
    </body>
</html>